# METABEGIN
# X-Env-Layer-Name: image-rota
# X-Env-Layer-Category: image
# X-Env-Layer-Desc: Immutable GPT A/B layout for rotational OTA updates,
#  boot/system redundancy, and a shared persistent data partition.
# X-Env-Layer-Version: 5.2.0
# X-Env-Layer-Requires: image-base,device-base,rpi-ab-slot-mapper,systemd-min
# X-Env-Layer-Provides: image
#
# X-Env-VarRequires: IGconf_device_storage_type,IGconf_device_class
# X-Env-VarRequires-Valid: string,regex:^(cm4|pi4|cm5|pi5)$
#
# X-Env-VarPrefix: image
#
# X-Env-Var-boot_part_size: 96M
# X-Env-Var-boot_part_size-Desc: Boot partition size per-slot.
# X-Env-Var-boot_part_size-Required: n
# X-Env-Var-boot_part_size-Valid: size
# X-Env-Var-boot_part_size-Set: y
#
# X-Env-Var-system_part_size: 512M
# X-Env-Var-system_part_size-Desc: System partition size per-slot.
# X-Env-Var-system_part_size-Required: n
# X-Env-Var-system_part_size-Valid: size
# X-Env-Var-system_part_size-Set: y
#
# X-Env-Var-data_part_size: 1G
# X-Env-Var-data_part_size-Desc: Writable data partition retained across
#  slot rotations.
# X-Env-Var-data_part_size-Required: n
# X-Env-Var-data_part_size-Valid: size
# X-Env-Var-data_part_size-Set: y
#
# X-Env-Var-rootfs_type: ext4
# X-Env-Var-rootfs_type-Desc: Root filesystem type for each system partition.
# X-Env-Var-rootfs_type-Required: n
# X-Env-Var-rootfs_type-Valid: ext4,erofs
# X-Env-Var-rootfs_type-Set: y
# X-Env-Var-rootfs_type-Triggers:
#  when=erofs set IGconf_image_erofs_comp_spec=zstd,3 policy lazy
#
# X-Env-Var-erofs_comp_spec: zstd,3
# X-Env-Var-erofs_comp_spec-Desc: EROFS compression specification passed verbatim
#  to mkfs.erofs -z
# X-Env-Var-erofs_comp_spec-Valid: regex:^zstd(,(level=)?[0-9]{1,2})?(,dictsize=[0-9]+)?$
# X-Env-Var-erofs_comp_spec-Set: n
# X-Env-Var-erofs_comp_spec-Conflicts: IGconf_image_rootfs_type=ext4
#
# X-Env-Var-assetdir: ${DIRECTORY}
# X-Env-Var-assetdir-Desc: Image specific asset directory
# X-Env-Var-assetdir-Required: n
# X-Env-Var-assetdir-Valid: string
# X-Env-Var-assetdir-Set: y
#
# X-Env-Var-pmap: clear
# X-Env-Var-pmap-Desc: Provisioning Map type for this image layout.
#  clear: All partitions will be provisioned unencrypted.
#  crypt: All non-boot partitions will be provisioned encrypted.
#  cryptslots: Only system OS partitions will be provisioned encrypted.
#  cryptdata: Only the data partition will be provisioned encrypted.
#  crypthybrid: B:system OS partition will be provisioned encrypted (dev only).
# X-Env-Var-pmap-Required: n
# X-Env-Var-pmap-Valid: clear,crypt,cryptslots,cryptdata,crypthybrid
# X-Env-Var-pmap-Set: y
#
# X-Env-Var-ptable_protect: n
# X-Env-Var-ptable_protect-Desc: Enable eMMC Power-On Write Protect of the partition
#  table. If enabled, the first 8MB of the boot storage device will be
#  protected. Applies to eMMC only.
# X-Env-Var-ptable_protect-Required: n
# X-Env-Var-ptable_protect-Valid: bool
# X-Env-Var-ptable_protect-Set: lazy
# X-Env-Var-ptable_protect-Conflicts: when=y IGconf_device_storage_type!=emmc
# X-Env-Var-ptable_protect-Triggers:
#  when=IGconf_device_storage_type=emmc set IGconf_image_ptable_protect=y policy=lazy
#
# X-Env-Var-compression: zstd
# X-Env-Var-compression-Desc: Compression scheme used for update payloads.
# X-Env-Var-compression-Required: n
# X-Env-Var-compression-Valid: string
# X-Env-Var-compression-Set: y
#
# METAEND
---
mmdebstrap:
  packages:
    - dosfstools
    - e2fsprogs
